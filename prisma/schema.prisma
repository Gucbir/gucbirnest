datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id       Int     @id @default(autoincrement())
  fullName String
  email    String?
  vkn      String  @unique
  phone    String?

  passwordHash             String
  role                     String                    @default("User")
  isActive                 Boolean                   @default(true)
  department               String?
  sapUserId                Int?
  defaultSapUser           SapUser?                  @relation("DefaultSapUser", fields: [sapUserId], references: [id])
  lastActionOperationUnits ProductionOperationUnit[] @relation("LastActionByUser")

  logs Log[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SapUser {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  description String?
  isActive    Boolean @default(true)

  defaultOfUsers User[] @relation("DefaultSapUser")
}

model Item {
  id          Int     @id @default(autoincrement())
  ItemCode    String  @unique
  ItemName    String
  ForeignName String?

  // SAP Flags (A≈üƒ±rƒ± kritik)
  ItemType      String // "I" (Inventory), "L" (Labor), "A" (Service)
  InventoryItem Boolean // tYES/tNO ‚Üí Prisma'da Boolean
  SalesItem     Boolean
  PurchaseItem  Boolean

  // Units of Measure
  InventoryUoM String?
  SalesUoM     String?
  PurchaseUoM  String?

  // √úr√ºn grubu
  ItemsGroupCode Int?

  // Minimum & Maximum Inventory (SAP OITM: MinInventory, MaxInventory)
  MinInventory    Float?
  MaxInventory    Float?
  QuantityOnStock Float? // Toplam mevcut stok miktarƒ±

  // Durumlar
  Valid     Boolean // tYES/tNO ‚Üí Boolean
  Frozen    Boolean // tYES/tNO ‚Üí Boolean
  AssetItem Boolean // tYES/tNO ‚Üí Boolean (Sabit kƒ±ymet)

  // Fiyat / Kost
  AvgPrice   Float? // OITM.AvgPrice
  LastPurPrc Float? // OITM.LastPurPrc
  LastPurCur String? // TRY, USD vs.

  // üî• ƒ∞Lƒ∞≈ûKƒ∞: Item -> ItemWarehouseStock
  warehouseStocks ItemWarehouseStock[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Warehouse {
  id       Int                  @id @default(autoincrement())
  WhsCode  String               @unique // "R1", "01", "ANA" vs
  WhsName  String
  isActive Boolean              @default(true)
  stocks   ItemWarehouseStock[]
}

model ItemWarehouseStock {
  id Int @id @default(autoincrement())

  item   Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId Int

  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  warehouseId Int

  // Hƒ±zlƒ± sorgu i√ßin kodlarƒ± da saklƒ±yoruz
  ItemCode String
  WhsCode  String

  InStock    Float // OITW.OnHand veya InventoryBalances.InStock
  IsCommited Float? // istersen ileride doldurursun
  OnOrder    Float? // istersen ileride doldurursun

  updatedAt DateTime @updatedAt

  @@unique([itemId, warehouseId])
  @@index([WhsCode])
  @@index([ItemCode])
}

model Log {
  id      Int    @id @default(autoincrement())
  path    String
  message String
  userId  Int

  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model ProductionOrder {
  id          Int                   @id @default(autoincrement())
  sapDocEntry Int? // SAP DocEntry
  sapDocNum   Int? // SAP DocNum
  itemCode    String
  itemName    String
  quantity    Int                   @default(1)
  status      String                @default("planned") // planned | in_progress | done | cancelled
  units       ProductionOrderUnit[]

  // Bir √ºretim sipari≈üinin t√ºm operasyonlarƒ±
  operations ProductionOperation[]
}

model ProductionOperation {
  id             Int       @id @default(autoincrement())
  orderId        Int
  stageCode      String // AKUPLE
  stageName      String // AKUPLE MONTAJ
  sequenceNo     Int // 10,20,30...
  departmentCode String // AKUPLE, MOTOR, TESISAT...
  status         String    @default("waiting") // waiting | in_progress | done
  startedAt      DateTime?
  finishedAt     DateTime?

  // ƒ∞Lƒ∞≈ûKƒ∞LER
  order           ProductionOrder            @relation(fields: [orderId], references: [id])
  operationUnits  ProductionOperationUnit[]
  alternativeLogs ProductionAlternativeLog[]

  // üî• TEK ili≈üki: bu operasyonun kalemleri
  items                                 ProductionOperationItem[]
  productionOperationUnitItemSelections ProductionOperationUnitItemSelection[]
}

model ProductionOperationItem {
  id          Int @id @default(autoincrement())
  operationId Int

  itemCode      String // orijinal √ºr√ºn
  itemName      String
  quantity      Float // planlanan miktar
  uomName       String?
  warehouseCode String? // planlanan depo
  issueMethod   String?
  lineNo        Int?

  // Ger√ßekte kullanƒ±lan √ºr√ºn (orijinal veya alternatif)
  selectedItemCode      String?
  selectedItemName      String?
  selectedWarehouseCode String?
  selectedQuantity      Float?
  isAlternative         Boolean @default(false)

  // SAP malzeme √ßƒ±kƒ±≈üƒ± belgesi (varsa)
  sapIssueDocEntry Int?

  // ƒ∞Lƒ∞≈ûKƒ∞
  alternativeLogs ProductionAlternativeLog[]
  unitSelections  ProductionOperationUnitItemSelection[]
  operation       ProductionOperation                    @relation(fields: [operationId], references: [id])
}

model Setting {
  id       Int    @id @default(autoincrement())
  name     String @unique
  settings Json

  createdAt DateTime @default(now())
}

model Form {
  id      Int    @id @default(autoincrement())
  name    String @unique
  values  Json
  orderNo Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OpenSalesOrder {
  id Int @id @default(autoincrement())

  // SAP anahtar
  docEntry Int  @unique
  docNum   Int?

  cardCode String?
  cardName String?

  docDate    DateTime?
  docDueDate DateTime?

  docTotal    Float?
  docTotalFc  Float?
  docCurrency String?

  comments String?

  documentStatus String? // bost_Open / bost_Close
  cancelled      String? // tNO / tYES

  // Bizim atayacaƒüƒ±mƒ±z kimlik
  serialNo String? @unique

  // Sync bilgisi
  syncedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  lines OpenSalesOrderLine[]
}

model OpenSalesOrderLine {
  id Int @id @default(autoincrement())

  // FK
  orderId Int
  order   OpenSalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // SAP line identity
  lineNum  Int // DocumentLines.LineNum
  docEntry Int // kolay sorgu i√ßin (redundant ama faydalƒ±)

  // temel √ºr√ºn bilgisi
  itemCode        String?
  itemDescription String?

  quantity  Float?
  unitPrice Float?
  currency  String?
  rate      Float?

  warehouseCode String?

  lineTotal  Float?
  rowTotalFC Float?
  rowTotalSC Float?

  lineStatus String? // bost_Open / bost_Close (satƒ±r durumu)

  shipDate DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderId, lineNum]) // aynƒ± sipari≈ü i√ßinde line num tekil
  @@index([docEntry])
  @@index([itemCode])
}

model ProductionStructureCache {
  id       Int    @id @default(autoincrement())
  itemCode String @unique

  // Snapshot data (senin return ettiƒüin yapƒ±)
  data Json

  // Versiyon / invalidation i√ßin alanlar
  dataHash  String? // JSON hash (deƒüi≈üti mi anlamak i√ßin)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([itemCode])
}

model MaterialShortageRun {
  id        Int      @id @default(autoincrement())
  payload   Json
  shortages Json
  createdAt DateTime @default(now())
}

model PurchaseRequest {
  id             Int     @id @default(autoincrement())
  source         String  @default("MATERIAL_SHORTAGE") // ileride ba≈üka kaynaklar da olur
  materialRunId  Int? // MaterialShortageRun.id referansƒ± (opsiyonel)
  docEntry       Int?
  sapDocNum      Int?
  parentItemCode String?
  requestedQty   Float?
  whsCode        String?

  status    String   @default("draft") // draft | sent | closed
  note      String?
  createdAt DateTime @default(now())

  items PurchaseRequestItem[]

  @@index([materialRunId])
  @@index([status])
}

model PurchaseRequestItem {
  id        Int             @id @default(autoincrement())
  requestId Int
  request   PurchaseRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  itemCode String
  itemName String?
  whsCode  String?
  required Float
  inStock  Float
  missing  Float

  // istersek alternatif: ‚Äúsatƒ±n alƒ±nacak miktar‚Äù
  purchaseQty Float

  // child/alt eksiklerden geldiyse baƒülamak i√ßin:
  parentItemCode String?
  parentItemName String?

  createdAt DateTime @default(now())

  @@index([itemCode])
  @@index([requestId])
}

model ProductionOrderUnit {
  id      Int             @id @default(autoincrement())
  orderId Int
  order   ProductionOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Her adet i√ßin tek seri
  serialNo String @unique

  // Opsiyonel: bu √ºniteye ait s√ºre√ß/√ßƒ±ktƒ±lar
  status    String                    @default("planned") // planned | in_progress | done | scrapped
  opUnits   ProductionOperationUnit[]
  createdAt DateTime                  @default(now())
  updatedAt DateTime                  @updatedAt

  itemSelections  ProductionOperationUnitItemSelection[]
  alternativeLogs ProductionAlternativeLog[]

  @@index([orderId])
}

model ProductionOperationUnit {
  id Int @id @default(autoincrement())

  operationId Int
  operation   ProductionOperation @relation(fields: [operationId], references: [id], onDelete: Cascade)

  unitId Int
  unit   ProductionOrderUnit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  status     String    @default("waiting") // waiting | in_progress | paused | done
  startedAt  DateTime?
  finishedAt DateTime?

  lastActionByUserId Int?
  lastActionByUser   User? @relation("LastActionByUser", fields: [lastActionByUserId], references: [id])

  pausedAt       DateTime?
  pausedTotalSec Int                          @default(0)
  logs           ProductionOperationUnitLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([operationId, unitId])
  @@index([operationId])
  @@index([unitId])
}

model ProductionOperationUnitLog {
  id Int @id @default(autoincrement())

  operationUnitId Int
  operationUnit   ProductionOperationUnit @relation(fields: [operationUnitId], references: [id], onDelete: Cascade)
  userId          Int?

  action String // start | pause | resume | finish
  reason String?
  note   String?

  createdAt DateTime @default(now())

  @@index([operationUnitId])
}

model ProductionOperationUnitItemSelection {
  id Int @id @default(autoincrement())

  operationId Int
  unitId      Int
  itemId      Int // ProductionOperationItem.id

  // se√ßilen √ºr√ºn bilgileri
  selectedItemCode      String?
  selectedItemName      String?
  selectedWarehouseCode String?
  selectedQuantity      Float?
  isAlternative         Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ili≈ükiler
  operation ProductionOperation     @relation(fields: [operationId], references: [id], onDelete: Cascade)
  unit      ProductionOrderUnit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  item      ProductionOperationItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([operationId, unitId, itemId])
  @@index([unitId])
  @@index([itemId])
}

model ProductionAlternativeLog {
  id Int @id @default(autoincrement())

  operationId Int
  unitId      Int
  itemId      Int // ProductionOperationItem.id

  // BOM (orijinal)
  bomItemCode String
  bomItemName String
  bomWhsCode  String?
  bomQty      Float?

  // Se√ßim (alternatif)
  selectedItemCode String?
  selectedItemName String?
  selectedWhsCode  String?
  selectedQty      Float?
  isAlternative    Boolean @default(false)

  // Kim yaptƒ±?
  userId Int?
  action String // select | clear | update

  // ƒ∞leride SAP √ßƒ±kƒ±≈üƒ±na baƒülamak istersen
  sapIssueDocEntry Int?

  note      String?
  createdAt DateTime @default(now())

  operation ProductionOperation     @relation(fields: [operationId], references: [id], onDelete: Cascade)
  unit      ProductionOrderUnit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  item      ProductionOperationItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([operationId])
  @@index([unitId])
  @@index([itemId])
}

model AkupleItemTemplate {
  id             Int     @id @default(autoincrement())
  parentItemCode String  @unique // ProductionOrder.itemCode (√∂rn: 6.xxxx)
  parentItemName String?
  version        Int     @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lines AkupleItemTemplateLine[]
}

model AkupleItemTemplateLine {
  id         Int @id @default(autoincrement())
  templateId Int

  itemCode      String
  itemName      String
  quantity      Float // ‚úÖ 1 unit i√ßin gereken miktar (per-unit)
  uomName       String?
  warehouseCode String?
  issueMethod   String?
  lineNo        Int?

  template AkupleItemTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, itemCode, lineNo])
  @@index([templateId])
}
