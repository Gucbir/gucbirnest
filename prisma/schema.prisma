datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id             Int      @id @default(autoincrement())
  fullName       String
  email          String   @unique
  passwordHash   String
  role           String   @default("User")
  isActive       Boolean  @default(true)
  department     String?
  sapUserId      Int?
  defaultSapUser SapUser? @relation("DefaultSapUser", fields: [sapUserId], references: [id])

  logs Log[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SapUser {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  description String?
  isActive    Boolean @default(true)

  defaultOfUsers User[] @relation("DefaultSapUser")
}

model Item {
  id          Int     @id @default(autoincrement())
  ItemCode    String  @unique
  ItemName    String
  ForeignName String?

  // SAP Flags (AÅŸÄ±rÄ± kritik)
  ItemType      String // "I" (Inventory), "L" (Labor), "A" (Service)
  InventoryItem Boolean // tYES/tNO â†’ Prisma'da Boolean
  SalesItem     Boolean
  PurchaseItem  Boolean

  // Units of Measure
  InventoryUoM String?
  SalesUoM     String?
  PurchaseUoM  String?

  // ÃœrÃ¼n grubu
  ItemsGroupCode Int?

  // Minimum & Maximum Inventory (SAP OITM: MinInventory, MaxInventory)
  MinInventory    Float?
  MaxInventory    Float?
  QuantityOnStock Float? // Toplam mevcut stok miktarÄ±

  // Durumlar
  Valid     Boolean // tYES/tNO â†’ Boolean
  Frozen    Boolean // tYES/tNO â†’ Boolean
  AssetItem Boolean // tYES/tNO â†’ Boolean (Sabit kÄ±ymet)

  // Fiyat / Kost
  AvgPrice   Float? // OITM.AvgPrice
  LastPurPrc Float? // OITM.LastPurPrc
  LastPurCur String? // TRY, USD vs.

  // ðŸ”¥ Ä°LÄ°ÅžKÄ°: Item -> ItemWarehouseStock
  warehouseStocks ItemWarehouseStock[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Warehouse {
  id       Int                  @id @default(autoincrement())
  WhsCode  String               @unique // "R1", "01", "ANA" vs
  WhsName  String
  isActive Boolean              @default(true)
  stocks   ItemWarehouseStock[]
}

model ItemWarehouseStock {
  id Int @id @default(autoincrement())

  item   Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId Int

  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  warehouseId Int

  // HÄ±zlÄ± sorgu iÃ§in kodlarÄ± da saklÄ±yoruz
  ItemCode String
  WhsCode  String

  InStock    Float // OITW.OnHand veya InventoryBalances.InStock
  IsCommited Float? // istersen ileride doldurursun
  OnOrder    Float? // istersen ileride doldurursun

  updatedAt DateTime @updatedAt

  @@unique([itemId, warehouseId])
  @@index([WhsCode])
  @@index([ItemCode])
}

model Log {
  id      Int    @id @default(autoincrement())
  path    String
  message String
  userId  Int

  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model Setting {
  id       Int    @id @default(autoincrement())
  name     String @unique
  settings Json

  createdAt DateTime @default(now())
}

model ProductionOrder {
  id          Int    @id @default(autoincrement())
  sapDocEntry Int? // SAP DocEntry
  sapDocNum   Int? // SAP DocNum
  itemCode    String
  itemName    String
  quantity    Float
  status      String @default("planned") // planned | in_progress | done | cancelled

  // Bir Ã¼retim sipariÅŸinin tÃ¼m operasyonlarÄ±
  operations ProductionOperation[]
}

model ProductionOperation {
  id             Int       @id @default(autoincrement())
  orderId        Int
  stageCode      String // AKUPLE
  stageName      String // AKUPLE MONTAJ
  sequenceNo     Int // 10,20,30...
  departmentCode String // AKUPLE, MOTOR, TESISAT...
  status         String    @default("waiting") // waiting | in_progress | done
  startedAt      DateTime?
  finishedAt     DateTime?

  // Ä°LÄ°ÅžKÄ°LER
  order ProductionOrder @relation(fields: [orderId], references: [id])

  // ðŸ”¥ TEK iliÅŸki: bu operasyonun kalemleri
  items ProductionOperationItem[]
}

model ProductionOperationItem {
  id          Int @id @default(autoincrement())
  operationId Int

  itemCode      String // orijinal Ã¼rÃ¼n
  itemName      String
  quantity      Float // planlanan miktar
  uomName       String?
  warehouseCode String? // planlanan depo
  issueMethod   String?
  lineNo        Int?

  // GerÃ§ekte kullanÄ±lan Ã¼rÃ¼n (orijinal veya alternatif)
  selectedItemCode      String?
  selectedItemName      String?
  selectedWarehouseCode String?
  selectedQuantity      Float?
  isAlternative         Boolean @default(false)

  // SAP malzeme Ã§Ä±kÄ±ÅŸÄ± belgesi (varsa)
  sapIssueDocEntry Int?

  // Ä°LÄ°ÅžKÄ°
  operation ProductionOperation @relation(fields: [operationId], references: [id])
}
